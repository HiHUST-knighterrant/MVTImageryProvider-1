import*as e from"cesium";var t=require("./mapbox-gl"),i=document.createElement("canvas");i.style.imageRendering="pixelated",i.addEventListener("webglcontextlost",function(){return console.log("webglcontextlost")},!1),i.width=1024,i.height=1024;var r=/*#__PURE__*/function(){function r(r){var n,o,s=this;this.mapboxRenderer=void 0,this.ready=void 0,this.readyPromise=void 0,this.rectangle=void 0,this.tileSize=void 0,this.tileWidth=void 0,this.tileHeight=void 0,this.maximumLevel=void 0,this.minimumLevel=void 0,this.tileDiscardPolicy=void 0,this.credit=void 0,this.proxy=void 0,this.hasAlphaChannel=void 0,this.sourceFilter=void 0,this.tilingScheme=void 0,this.options=void 0,this.transformRequest=function(e){return s.options.headers?{url:e,headers:s.options.headers}:{url:e}},this.options=r,this.mapboxRenderer=new t.BasicRenderer({style:r.style,transformRequest:function(e){return s.transformRequest(e)}}),this.mapboxRenderer._canvas=i,this.mapboxRenderer._canvas.addEventListener("webglcontextrestored",function(){return s.mapboxRenderer._createGlContext()},!1),this.mapboxRenderer._createGlContext(),r.showCanvas&&this.mapboxRenderer.showCanvasForDebug(),this.ready=!1,this.readyPromise=this.mapboxRenderer._style.loadedPromise.then(function(){s.ready=!0}),this.tilingScheme=null!=(n=r.tilingScheme)?n:new e.WebMercatorTilingScheme,this.rectangle=this.tilingScheme.rectangle,this.tileSize=this.tileWidth=this.tileHeight=r.tileSize||1024,this.maximumLevel=r.maximumLevel||Number.MAX_SAFE_INTEGER,this.minimumLevel=r.minimumLevel||0,this.tileDiscardPolicy=void 0,this.credit=new e.Credit(r.credit||"",!1),this.proxy=new e.DefaultProxy(""),this.hasAlphaChannel=null==(o=r.hasAlphaChannel)||o,this.sourceFilter=r.sourceFilter}var n=r.prototype;return n.createTile=function(){var e=document.createElement("canvas");e.width=this.tileSize,e.height=this.tileSize,e.style.imageRendering="pixelated";var t=e.getContext("2d");return t&&(t.globalCompositeOperation="copy"),e},n.canvasToImage=function(e){try{var t=new Image;return Promise.resolve(new Promise(function(i){t.onload=function(){i(t)},t.crossOrigin="",t.src=e.toDataURL("image/png")}))}catch(e){return Promise.reject(e)}},n.requestImage=function(e,t,i,r){var n=this;if(void 0===r&&(r=!0),i>this.maximumLevel||i<this.minimumLevel)return Promise.reject(void 0);this.mapboxRenderer.filterForZoom(i);var o=[];return this.mapboxRenderer.getVisibleSources(i).forEach(function(r){o.push({source:r,z:i,x:e,y:t,left:0,top:0,size:n.tileSize})}),new Promise(function(e,t){var i=n.createTile(),s=n.mapboxRenderer.renderTiles(i.getContext("2d"),{srcLeft:0,srcTop:0,width:n.tileSize,height:n.tileSize,destLeft:0,destTop:0},o,function(o){try{var a=function(){if(o)t(void 0);else{var a=function(){if(r)return s.consumer.ctx=null,Promise.resolve(n.canvasToImage(i)).then(function(t){var i,r;e(t),n.mapboxRenderer.releaseRender(s),null==(i=n.mapboxRenderer._style.sourceCaches)||null==(r=i.origin)||r._tileCache.reset()});e(s)}();if(a&&a.then)return a.then(function(){})}}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})})},n.pickFeatures=function(t,i,r,n,o){var s,a=this;return null==(s=this.requestImage(t,i,r,!1))?void 0:s.then(function(t){var i,s,l=a.mapboxRenderer.getVisibleSources(r);l=a.sourceFilter?a.sourceFilter(l):l;var h=[],c=e.Math.toDegrees(n),u=e.Math.toDegrees(o);return l.forEach(function(e){h.push({data:a.mapboxRenderer.queryRenderedFeatures({source:e,renderedZoom:r,lng:c,lat:u,tileZ:r})})}),console.log(h),t.consumer.ctx=void 0,a.mapboxRenderer.releaseRender(t),null==(i=a.mapboxRenderer._style.sourceCaches)||null==(s=i.origin)||s._tileCache.reset(),h})},r}();export{r as default};
//# sourceMappingURL=index.module.js.map
