{"version":3,"file":"index.module.js","sources":["../src/utils/MVTImageryProvider/index.ts"],"sourcesContent":["\nimport * as Cesium from \"cesium\";\nconst mapbox = require('./mapbox-gl');\n\nimport type { Credit, WebMercatorTilingScheme, DefaultProxy, GeographicTilingScheme } from \"cesium\";\n\n/**\n *\n * @param {Object} options\n * @param {Object} options.style - mapbox style object\n * @param {Function} [options.sourceFilter] - sourceFilter is used to filter which source participate in pickFeature process.\n * @param {Number} [options.maximumLevel] - if cesium zoom level exceeds maximumLevel, layer will be invisible.\n * @param {Number} [options.minimumLevel] - if cesium zoom level belows minimumLevel, layer will be invisible.\n * @param {Number} [options.tileSize] - can be 256 or 512.\n * @param {Boolean} [options.hasAlphaChannel] -\n * @param {String} [options.credit] -\n *\n */\ntype MVTImageryProviderOptions = {\n  style: any;\n  showCanvas?: boolean;\n  tileSize?: number;\n  tileWidth?: number;\n  tileHeight?: number;\n  maximumLevel?: number;\n  minimumLevel?: number;\n  tileDiscardPolicy?: undefined;\n  credit?: string;\n  hasAlphaChannel?: boolean;\n  sourceFilter?: any;\n  headers?: HeadersInit;\n  tilingScheme?: WebMercatorTilingScheme | GeographicTilingScheme;\n}\n// 创建一个全局变量作为pbfBasicRenderer渲染模板，避免出现16个canvas上下文的浏览器限制，以便Cesium ImageLayer.destory()正常工作。\n// https://github.com/mapbox/mapbox-gl-js/issues/7332\nconst OFFSCREEN_CANV_SIZE = 1024;\nconst baseCanv = document.createElement('canvas');\nbaseCanv.style.imageRendering = 'pixelated';\nbaseCanv.addEventListener('webglcontextlost', () => console.log(\"webglcontextlost\"), false);\nbaseCanv.width = OFFSCREEN_CANV_SIZE;\nbaseCanv.height = OFFSCREEN_CANV_SIZE;\nclass MVTImageryProvider {\n  mapboxRenderer: any;\n  ready: boolean;\n  readyPromise: Promise<void>;\n  rectangle: any;\n  tileSize: number;\n  tileWidth: number;\n  tileHeight: number;\n  maximumLevel: number;\n  minimumLevel: number;\n  tileDiscardPolicy: undefined;\n  credit: Credit;\n  proxy: DefaultProxy;\n  hasAlphaChannel: boolean;\n  sourceFilter: any;\n  tilingScheme: WebMercatorTilingScheme | GeographicTilingScheme;\n  options: MVTImageryProviderOptions;\n\n  /**\n   * create a MVTImageryProvider Object\n   * @param options MVTImageryProvider options\n   * @param options.style - mapbox style object\n   * @param options.sourceFilter - sourceFilter is used to filter which source participate in pickFeature process.\n   * @param options.maximumLevel - if cesium zoom level exceeds maximumLevel, layer will be invisible.\n   * @param options.minimumLevel - if cesium zoom level belows minimumLevel, layer will be invisible.\n   * @param options.tileSize - can be 256 or 512. 256 default\n   * @param options.headers - url fetch request headers\n   * @param options.tilingScheme - Cesium tilingScheme, default WebMercatorTilingScheme(EPSG: 3857)\n   */\n  constructor(options: MVTImageryProviderOptions) {\n    this.options = options;\n\n    this.mapboxRenderer = new mapbox.BasicRenderer({\n      style: options.style,\n      transformRequest: (url: string) => this.transformRequest(url),\n    });\n\n    this.mapboxRenderer._canvas = baseCanv;\n    this.mapboxRenderer._canvas.addEventListener('webglcontextrestored', () => this.mapboxRenderer._createGlContext(), false);\n    this.mapboxRenderer._createGlContext();\n\n    if (options.showCanvas) {\n      this.mapboxRenderer.showCanvasForDebug();\n    }\n\n    this.ready = false;\n    this.readyPromise = this.mapboxRenderer._style.loadedPromise.then(() => {\n      this.ready = true;\n    });\n\n    this.tilingScheme = options.tilingScheme ?? new Cesium.WebMercatorTilingScheme();;\n    this.rectangle = this.tilingScheme.rectangle;\n    this.tileSize = this.tileWidth = this.tileHeight = options.tileSize || 1024;\n    this.maximumLevel = options.maximumLevel || Number.MAX_SAFE_INTEGER;\n    this.minimumLevel = options.minimumLevel || 0;\n    this.tileDiscardPolicy = undefined;\n    //this.errorEvent = new Cesium.Event();\n    this.credit = new Cesium.Credit(options.credit || \"\", false);\n    this.proxy = new Cesium.DefaultProxy(\"\");\n    this.hasAlphaChannel = options.hasAlphaChannel ?? true;\n    this.sourceFilter = options.sourceFilter;\n  }\n\n  transformRequest = (url: string) => {\n    if (this.options.headers) {\n      return {\n        url,\n        headers: this.options.headers\n      }\n    }\n    return {\n      url\n    };\n  }\n\n  createTile() {\n    const canv = document.createElement(\"canvas\");\n    canv.width = this.tileSize;\n    canv.height = this.tileSize;\n    canv.style.imageRendering = \"pixelated\";\n    const ctx = canv.getContext(\"2d\");\n    if (ctx) {\n      ctx.globalCompositeOperation = \"copy\";\n    }\n    return canv;\n  }\n\n  async canvasToImage(canvas: HTMLCanvasElement): Promise<HTMLImageElement> {\n    const img = new Image();\n    return new Promise((resolve) => {\n      img.onload = function () {\n        resolve(img);\n      };\n      img.crossOrigin = \"\";\n      img.src = canvas.toDataURL(\"image/png\");\n    });\n  }\n\n  requestImage(\n    x: any,\n    y: any,\n    zoom: number,\n    releaseTile = true\n  ): Promise<HTMLImageElement | HTMLCanvasElement | any> | undefined {\n    if (zoom > this.maximumLevel || zoom < this.minimumLevel) {\n      return Promise.reject(undefined);\n    }\n\n    this.mapboxRenderer.filterForZoom(zoom);\n    const tilesSpec: { source: string; z: number; x: any; y: any; left: number; top: number; size: number; }[] = [];\n    this.mapboxRenderer.getVisibleSources(zoom).forEach((s: any) => {\n      tilesSpec.push({\n        source: s,\n        z: zoom,\n        x: x,\n        y: y,\n        left: 0,\n        top: 0,\n        size: this.tileSize,\n      });\n    });\n\n    return new Promise((resolve, reject) => {\n      const canv = this.createTile();\n      const renderRef = this.mapboxRenderer.renderTiles(\n        canv.getContext(\"2d\"),\n        {\n          srcLeft: 0,\n          srcTop: 0,\n          width: this.tileSize,\n          height: this.tileSize,\n          destLeft: 0,\n          destTop: 0,\n        },\n        tilesSpec,\n        async (err: any) => {\n          if (!!err) {\n            switch (err) {\n              case \"canceled\":\n              case \"fully-canceled\":\n                reject(undefined);\n                break;\n              default:\n                reject(undefined);\n            }\n          } else {\n            if (releaseTile) {\n              renderRef.consumer.ctx = null;\n              const img = await this.canvasToImage(canv);\n              resolve(img);\n              // releaseTile默认为true，对应Cesium请求图像的情形\n              this.mapboxRenderer.releaseRender(renderRef);\n              this.mapboxRenderer._style.sourceCaches?.origin?._tileCache.reset();\n            } else {\n              // releaseTile为false时在由pickFeature手动调用，在渲染完成之后在pickFeature里边手动释放tile\n              resolve(renderRef);\n            }\n          }\n        }\n      );\n    });\n  }\n\n  pickFeatures(x: any, y: any, zoom: number, longitude: any, latitude: any) {\n    return this.requestImage(x, y, zoom, false)?.then((renderRef) => {\n      let targetSources = this.mapboxRenderer.getVisibleSources(zoom);\n      targetSources = this.sourceFilter\n        ? this.sourceFilter(targetSources)\n        : targetSources;\n\n      const queryResult: any[] | PromiseLike<any[]> = [];\n\n      const lng = Cesium.Math.toDegrees(longitude);\n      const lat = Cesium.Math.toDegrees(latitude);\n\n      targetSources.forEach((s: any) => {\n        queryResult.push({\n          data: this.mapboxRenderer.queryRenderedFeatures({\n            source: s,\n            renderedZoom: zoom,\n            lng,\n            lat,\n            tileZ: zoom,\n          }),\n        });\n      });\n\n      console.log(queryResult)\n\n      // release tile\n      renderRef.consumer.ctx = undefined;\n      this.mapboxRenderer.releaseRender(renderRef);\n      this.mapboxRenderer._style.sourceCaches?.origin?._tileCache.reset();\n      return queryResult;\n    });\n  }\n}\n\nexport default MVTImageryProvider;\n"],"names":["mapbox","require","baseCanv","document","createElement","style","imageRendering","addEventListener","console","log","width","height","MVTImageryProvider","options","mapboxRenderer","ready","readyPromise","rectangle","tileSize","this","tileWidth","tileHeight","maximumLevel","minimumLevel","tileDiscardPolicy","credit","proxy","hasAlphaChannel","sourceFilter","tilingScheme","transformRequest","url","_this","headers","BasicRenderer","_canvas","_createGlContext","showCanvas","showCanvasForDebug","_style","loadedPromise","then","_options$tilingScheme","Cesium","WebMercatorTilingScheme","Number","MAX_SAFE_INTEGER","undefined","Credit","DefaultProxy","_options$hasAlphaChan","createTile","canv","ctx","getContext","globalCompositeOperation","canvasToImage","canvas","img","Image","Promise","resolve","onload","crossOrigin","src","toDataURL","requestImage","x","y","zoom","releaseTile","_this2","reject","filterForZoom","tilesSpec","getVisibleSources","forEach","s","push","source","z","left","top","size","renderRef","renderTiles","srcLeft","srcTop","destLeft","destTop","err","_temp3","_temp4","consumer","_this2$mapboxRenderer","_this2$mapboxRenderer2","releaseRender","sourceCaches","origin","_tileCache","reset","e","pickFeatures","longitude","latitude","_this$requestImage","_this3$mapboxRenderer","_this3$mapboxRenderer2","targetSources","_this3","queryResult","lng","Math","toDegrees","lat","data","queryRenderedFeatures","renderedZoom","tileZ"],"mappings":"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"}