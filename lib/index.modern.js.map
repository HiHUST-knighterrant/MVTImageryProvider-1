{"version":3,"file":"index.modern.js","sources":["../src/utils/MVTImageryProvider/index.ts"],"sourcesContent":["\nimport * as Cesium from \"cesium\";\nconst mapbox = require('./mapbox-gl');\n\nimport type { Credit, WebMercatorTilingScheme, DefaultProxy, GeographicTilingScheme } from \"cesium\";\n\n/**\n *\n * @param {Object} options\n * @param {Object} options.style - mapbox style object\n * @param {Function} [options.sourceFilter] - sourceFilter is used to filter which source participate in pickFeature process.\n * @param {Number} [options.maximumLevel] - if cesium zoom level exceeds maximumLevel, layer will be invisible.\n * @param {Number} [options.minimumLevel] - if cesium zoom level belows minimumLevel, layer will be invisible.\n * @param {Number} [options.tileSize] - can be 256 or 512.\n * @param {Boolean} [options.hasAlphaChannel] -\n * @param {String} [options.credit] -\n *\n */\ntype MVTImageryProviderOptions = {\n  style: any;\n  showCanvas?: boolean;\n  tileSize?: number;\n  tileWidth?: number;\n  tileHeight?: number;\n  maximumLevel?: number;\n  minimumLevel?: number;\n  tileDiscardPolicy?: undefined;\n  credit?: string;\n  hasAlphaChannel?: boolean;\n  sourceFilter?: any;\n  headers?: HeadersInit;\n  tilingScheme?: WebMercatorTilingScheme | GeographicTilingScheme;\n}\n// 创建一个全局变量作为pbfBasicRenderer渲染模板，避免出现16个canvas上下文的浏览器限制，以便Cesium ImageLayer.destory()正常工作。\n// https://github.com/mapbox/mapbox-gl-js/issues/7332\nconst OFFSCREEN_CANV_SIZE = 1024;\nconst baseCanv = document.createElement('canvas');\nbaseCanv.style.imageRendering = 'pixelated';\nbaseCanv.addEventListener('webglcontextlost', () => console.log(\"webglcontextlost\"), false);\nbaseCanv.width = OFFSCREEN_CANV_SIZE;\nbaseCanv.height = OFFSCREEN_CANV_SIZE;\nclass MVTImageryProvider {\n  mapboxRenderer: any;\n  ready: boolean;\n  readyPromise: Promise<void>;\n  rectangle: any;\n  tileSize: number;\n  tileWidth: number;\n  tileHeight: number;\n  maximumLevel: number;\n  minimumLevel: number;\n  tileDiscardPolicy: undefined;\n  credit: Credit;\n  proxy: DefaultProxy;\n  hasAlphaChannel: boolean;\n  sourceFilter: any;\n  tilingScheme: WebMercatorTilingScheme | GeographicTilingScheme;\n  options: MVTImageryProviderOptions;\n\n  /**\n   * create a MVTImageryProvider Object\n   * @param options MVTImageryProvider options\n   * @param options.style - mapbox style object\n   * @param options.sourceFilter - sourceFilter is used to filter which source participate in pickFeature process.\n   * @param options.maximumLevel - if cesium zoom level exceeds maximumLevel, layer will be invisible.\n   * @param options.minimumLevel - if cesium zoom level belows minimumLevel, layer will be invisible.\n   * @param options.tileSize - can be 256 or 512. 256 default\n   * @param options.headers - url fetch request headers\n   * @param options.tilingScheme - Cesium tilingScheme, default WebMercatorTilingScheme(EPSG: 3857)\n   */\n  constructor(options: MVTImageryProviderOptions) {\n    this.options = options;\n\n    this.mapboxRenderer = new mapbox.BasicRenderer({\n      style: options.style,\n      transformRequest: (url: string) => this.transformRequest(url),\n    });\n\n    this.mapboxRenderer._canvas = baseCanv;\n    this.mapboxRenderer._canvas.addEventListener('webglcontextrestored', () => this.mapboxRenderer._createGlContext(), false);\n    this.mapboxRenderer._createGlContext();\n\n    if (options.showCanvas) {\n      this.mapboxRenderer.showCanvasForDebug();\n    }\n\n    this.ready = false;\n    this.readyPromise = this.mapboxRenderer._style.loadedPromise.then(() => {\n      this.ready = true;\n    });\n\n    this.tilingScheme = options.tilingScheme ?? new Cesium.WebMercatorTilingScheme();;\n    this.rectangle = this.tilingScheme.rectangle;\n    this.tileSize = this.tileWidth = this.tileHeight = options.tileSize || 1024;\n    this.maximumLevel = options.maximumLevel || Number.MAX_SAFE_INTEGER;\n    this.minimumLevel = options.minimumLevel || 0;\n    this.tileDiscardPolicy = undefined;\n    //this.errorEvent = new Cesium.Event();\n    this.credit = new Cesium.Credit(options.credit || \"\", false);\n    this.proxy = new Cesium.DefaultProxy(\"\");\n    this.hasAlphaChannel = options.hasAlphaChannel ?? true;\n    this.sourceFilter = options.sourceFilter;\n  }\n\n  transformRequest = (url: string) => {\n    if (this.options.headers) {\n      return {\n        url,\n        headers: this.options.headers\n      }\n    }\n    return {\n      url\n    };\n  }\n\n  createTile() {\n    const canv = document.createElement(\"canvas\");\n    canv.width = this.tileSize;\n    canv.height = this.tileSize;\n    canv.style.imageRendering = \"pixelated\";\n    const ctx = canv.getContext(\"2d\");\n    if (ctx) {\n      ctx.globalCompositeOperation = \"copy\";\n    }\n    return canv;\n  }\n\n  async canvasToImage(canvas: HTMLCanvasElement): Promise<HTMLImageElement> {\n    const img = new Image();\n    return new Promise((resolve) => {\n      img.onload = function () {\n        resolve(img);\n      };\n      img.crossOrigin = \"\";\n      img.src = canvas.toDataURL(\"image/png\");\n    });\n  }\n\n  requestImage(\n    x: any,\n    y: any,\n    zoom: number,\n    releaseTile = true\n  ): Promise<HTMLImageElement | HTMLCanvasElement | any> | undefined {\n    if (zoom > this.maximumLevel || zoom < this.minimumLevel) {\n      return Promise.reject(undefined);\n    }\n\n    this.mapboxRenderer.filterForZoom(zoom);\n    const tilesSpec: { source: string; z: number; x: any; y: any; left: number; top: number; size: number; }[] = [];\n    this.mapboxRenderer.getVisibleSources(zoom).forEach((s: any) => {\n      tilesSpec.push({\n        source: s,\n        z: zoom,\n        x: x,\n        y: y,\n        left: 0,\n        top: 0,\n        size: this.tileSize,\n      });\n    });\n\n    return new Promise((resolve, reject) => {\n      const canv = this.createTile();\n      const renderRef = this.mapboxRenderer.renderTiles(\n        canv.getContext(\"2d\"),\n        {\n          srcLeft: 0,\n          srcTop: 0,\n          width: this.tileSize,\n          height: this.tileSize,\n          destLeft: 0,\n          destTop: 0,\n        },\n        tilesSpec,\n        async (err: any) => {\n          if (!!err) {\n            switch (err) {\n              case \"canceled\":\n              case \"fully-canceled\":\n                reject(undefined);\n                break;\n              default:\n                reject(undefined);\n            }\n          } else {\n            if (releaseTile) {\n              renderRef.consumer.ctx = null;\n              const img = await this.canvasToImage(canv);\n              resolve(img);\n              // releaseTile默认为true，对应Cesium请求图像的情形\n              this.mapboxRenderer.releaseRender(renderRef);\n              this.mapboxRenderer._style.sourceCaches?.origin?._tileCache.reset();\n            } else {\n              // releaseTile为false时在由pickFeature手动调用，在渲染完成之后在pickFeature里边手动释放tile\n              resolve(renderRef);\n            }\n          }\n        }\n      );\n    });\n  }\n\n  pickFeatures(x: any, y: any, zoom: number, longitude: any, latitude: any) {\n    return this.requestImage(x, y, zoom, false)?.then((renderRef) => {\n      let targetSources = this.mapboxRenderer.getVisibleSources(zoom);\n      targetSources = this.sourceFilter\n        ? this.sourceFilter(targetSources)\n        : targetSources;\n\n      const queryResult: any[] | PromiseLike<any[]> = [];\n\n      const lng = Cesium.Math.toDegrees(longitude);\n      const lat = Cesium.Math.toDegrees(latitude);\n\n      targetSources.forEach((s: any) => {\n        queryResult.push({\n          data: this.mapboxRenderer.queryRenderedFeatures({\n            source: s,\n            renderedZoom: zoom,\n            lng,\n            lat,\n            tileZ: zoom,\n          }),\n        });\n      });\n\n      console.log(queryResult)\n\n      // release tile\n      renderRef.consumer.ctx = undefined;\n      this.mapboxRenderer.releaseRender(renderRef);\n      this.mapboxRenderer._style.sourceCaches?.origin?._tileCache.reset();\n      return queryResult;\n    });\n  }\n}\n\nexport default MVTImageryProvider;\n"],"names":["mapbox","require","baseCanv","document","createElement","style","imageRendering","addEventListener","console","log","width","height","MVTImageryProvider","constructor","options","mapboxRenderer","ready","readyPromise","rectangle","this","tileSize","tileWidth","tileHeight","maximumLevel","minimumLevel","tileDiscardPolicy","credit","proxy","hasAlphaChannel","sourceFilter","tilingScheme","transformRequest","url","headers","BasicRenderer","_canvas","_createGlContext","showCanvas","showCanvasForDebug","_style","loadedPromise","then","_options$tilingScheme","Cesium","WebMercatorTilingScheme","Number","MAX_SAFE_INTEGER","undefined","Credit","DefaultProxy","_options$hasAlphaChan","createTile","canv","ctx","getContext","globalCompositeOperation","async","canvas","img","Image","Promise","resolve","onload","crossOrigin","src","toDataURL","requestImage","x","y","zoom","releaseTile","_this","reject","filterForZoom","tilesSpec","getVisibleSources","forEach","s","push","source","z","left","top","size","renderRef","renderTiles","srcLeft","srcTop","destLeft","destTop","err","_this$mapboxRenderer$","_this$mapboxRenderer$2","consumer","canvasToImage","releaseRender","sourceCaches","origin","_tileCache","reset","pickFeatures","longitude","latitude","_this$requestImage","_this$mapboxRenderer$3","_this$mapboxRenderer$4","targetSources","queryResult","lng","Math","toDegrees","lat","data","queryRenderedFeatures","renderedZoom","tileZ"],"mappings":"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"}