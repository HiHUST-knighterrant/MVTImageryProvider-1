{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["\nimport * as Cesium from \"cesium/Cesium\";\nimport { BasicRenderer } from \"pbf-basic-render\";\n\nimport type { Credit, WebMercatorTilingScheme, DefaultProxy, GeographicTilingScheme } from \"cesium\";\n\n/**\n *\n * @param {Object} options\n * @param {Object} options.style - mapbox style object\n * @param {Function} [options.sourceFilter] - sourceFilter is used to filter which source participate in pickFeature process.\n * @param {Number} [options.maximumLevel] - if cesium zoom level exceeds maximumLevel, layer will be invisible.\n * @param {Number} [options.minimumLevel] - if cesium zoom level belows minimumLevel, layer will be invisible.\n * @param {Number} [options.tileSize] - can be 256 or 512.\n * @param {Boolean} [options.hasAlphaChannel] -\n * @param {String} [options.credit] -\n *\n */\ntype MVTImageryProviderOptions = {\n  style: any;\n  showCanvas?: boolean;\n  tileSize?: number;\n  tileWidth?: number;\n  tileHeight?: number;\n  maximumLevel?: number;\n  minimumLevel?: number;\n  tileDiscardPolicy?: undefined;\n  credit?: Credit;\n  hasAlphaChannel?: boolean;\n  sourceFilter?: any;\n  header?: any;\n  tilingScheme?: WebMercatorTilingScheme | GeographicTilingScheme;\n}\n\nclass MVTImageryProvider {\n  mapboxRenderer: BasicRenderer;\n  ready: boolean;\n  readyPromise: Promise<void>;\n  rectangle: any;\n  tileSize: number;\n  tileWidth: number;\n  tileHeight: number;\n  maximumLevel: number;\n  minimumLevel: number;\n  tileDiscardPolicy: undefined;\n  proxy: DefaultProxy;\n  hasAlphaChannel: boolean;\n  sourceFilter: any;\n  tilingScheme: WebMercatorTilingScheme | GeographicTilingScheme;\n  options: MVTImageryProviderOptions;\n\n  constructor(options: MVTImageryProviderOptions) {\n    this.options = options;\n\n    this.mapboxRenderer = new BasicRenderer({\n      style: options.style,\n      transformRequest: (url: string, type: any) => this.transformRequest(url, type),\n    });\n\n    if (options.showCanvas) {\n      this.mapboxRenderer.showCanvasForDebug();\n    }\n\n    this.ready = false;\n    this.readyPromise = this.mapboxRenderer._style.loadedPromise.then(() => {\n      this.ready = true;\n    });\n\n    this.tilingScheme = options.tilingScheme ?? new Cesium.WebMercatorTilingScheme();;\n    this.rectangle = this.tilingScheme.rectangle;\n    this.tileSize = this.tileWidth = this.tileHeight = options.tileSize || 512;\n    this.maximumLevel = options.maximumLevel || Number.MAX_SAFE_INTEGER;\n    this.minimumLevel = options.minimumLevel || 0;\n    this.tileDiscardPolicy = undefined;\n    //this.errorEvent = new Cesium.Event();\n    this.proxy = new Cesium.DefaultProxy(\"\");\n    this.hasAlphaChannel = options.hasAlphaChannel ?? true;\n    this.sourceFilter = options.sourceFilter;\n    this.options = options;\n  }\n\n  transformRequest = (url: string, resourceType: string) => {\n    if (resourceType === 'Source' && this.options.header) {\n      return {\n        url,\n        headers: this.options.header\n      }\n    }\n    return {\n      url\n    };\n  }\n\n  // @ts-ignore\n  getTileCredits(x, y, level) {\n    return [];\n  }\n\n  createTile() {\n    const canv = document.createElement(\"canvas\");\n    canv.width = this.tileSize;\n    canv.height = this.tileSize;\n    canv.style.imageRendering = \"pixelated\";\n    const ctx = canv.getContext(\"2d\");\n    if (ctx) {\n      ctx.globalCompositeOperation = \"copy\";\n    }\n    return canv;\n  }\n\n  requestImage(\n    x: any,\n    y: any,\n    zoom: number,\n    releaseTile = true\n  ): Promise<HTMLImageElement | HTMLCanvasElement | any> | undefined {\n    if (zoom > this.maximumLevel || zoom < this.minimumLevel) {\n      return Promise.reject(undefined);\n    }\n\n    this.mapboxRenderer.filterForZoom(zoom);\n    const tilesSpec: { source: string; z: number; x: any; y: any; left: number; top: number; size: number; }[] = [];\n    this.mapboxRenderer.getVisibleSources(zoom).forEach((s: any) => {\n      tilesSpec.push({\n        source: s,\n        z: zoom,\n        x: x,\n        y: y,\n        left: 0,\n        top: 0,\n        size: this.tileSize,\n      });\n    });\n\n    console.log('tilesSpec', tilesSpec)\n\n    return new Promise((resolve, reject) => {\n      const canv = this.createTile();\n      const renderRef = this.mapboxRenderer.renderTiles(\n        canv.getContext(\"2d\"),\n        {\n          srcLeft: 0,\n          srcTop: 0,\n          width: this.tileSize,\n          height: this.tileSize,\n          destLeft: 0,\n          destTop: 0,\n        },\n        tilesSpec,\n        (err: any) => {\n          if (!!err) {\n            console.error(err);\n            switch (err) {\n              case \"canceled\":\n              case \"fully-canceled\":\n                reject(undefined);\n                break;\n              default:\n                reject(undefined);\n            }\n          } else {\n            if (releaseTile) {\n              renderRef.consumer.ctx = undefined;\n              resolve(canv);\n              // releaseTile默认为true，对应Cesium请求图像的情形\n              this.mapboxRenderer.releaseRender(renderRef);\n            } else {\n              // releaseTile为false时在由pickFeature手动调用，在渲染完成之后在pickFeature里边手动释放tile\n              resolve(renderRef);\n            }\n          }\n        }\n      );\n    });\n  }\n\n  pickFeatures(x: any, y: any, zoom: number, longitude: any, latitude: any) {\n    return this.requestImage(x, y, zoom, false)?.then((renderRef) => {\n      let targetSources = this.mapboxRenderer.getVisibleSources(zoom);\n      targetSources = this.sourceFilter\n        ? this.sourceFilter(targetSources)\n        : targetSources;\n\n      const queryResult: any[] | PromiseLike<any[]> = [];\n\n      const lng = Cesium.Math.toDegrees(longitude);\n      const lat = Cesium.Math.toDegrees(latitude);\n\n      targetSources.forEach((s: any) => {\n        queryResult.push({\n          data: this.mapboxRenderer.queryRenderedFeatures({\n            source: s,\n            renderedZoom: zoom,\n            lng,\n            lat,\n            tileZ: zoom,\n          }),\n        });\n      });\n\n      // release tile\n      renderRef.consumer.ctx = undefined;\n      this.mapboxRenderer.releaseRender(renderRef);\n      return queryResult;\n    });\n  }\n}\n\nexport default MVTImageryProvider;\n"],"names":["MVTImageryProvider","constructor","options","mapboxRenderer","ready","readyPromise","rectangle","tileSize","tileWidth","tileHeight","maximumLevel","minimumLevel","tileDiscardPolicy","proxy","hasAlphaChannel","sourceFilter","tilingScheme","transformRequest","url","resourceType","this","header","headers","BasicRenderer","style","type","showCanvas","showCanvasForDebug","_style","loadedPromise","then","Cesium","WebMercatorTilingScheme","Number","MAX_SAFE_INTEGER","undefined","DefaultProxy","getTileCredits","x","y","level","createTile","canv","document","createElement","width","height","imageRendering","ctx","getContext","globalCompositeOperation","requestImage","zoom","releaseTile","Promise","reject","filterForZoom","tilesSpec","getVisibleSources","forEach","s","push","source","z","left","top","size","console","log","resolve","renderRef","renderTiles","srcLeft","srcTop","destLeft","destTop","err","error","consumer","releaseRender","pickFeatures","longitude","latitude","_this$requestImage","targetSources","queryResult","lng","Math","toDegrees","lat","data","queryRenderedFeatures","renderedZoom","tileZ"],"mappings":"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"}